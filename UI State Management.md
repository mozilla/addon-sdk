## Proposal

Addon SDK UI components should be extendable.  However SDK UI
components also have state, and state scopes (global/window/tab)
which need to be considered.  Therefore in order to support
both state scopes and extensibility there needs to be a mechanism
for which other add-ons can fetch and change states for specific
scopes.

The web has REST which provides a solution to this problem domain
in a different context, the web.  REST is implemented by storing
state in a server and communicating state over the HTTP protocol.

The Firefox should behave similiarly, but in it's specific context.

### Use Cases

#### Intra-SDK Component Synchronization

Sidebars require menuitems, and it must be possible to attach a button
to them easily.  Buttons however can also have states that are scope
specific, which means they can have a state for a tab that is different
from other tabs for example.  This state scoping must also be possible
for Sidebars at some point.  Therefore all of these separate UI components
must have some means for grouping, whereby they are
updating each other about state changes which
the others need to react to.

#### Inter Add-on Component Synchronization

In order to have the SDK UI components be extendable, that is so that
other add-ons can make changes to their state or add other components
(be they UI or otherwise) to their group there must be some means for
which these extended components can post/fetch upddates for the group
of components.

## Implementation

State for components will be stored in a private scope provided
by the SDK loader associated to the source add-on for which the extendable
UI components were created.  Information about the component states
will transported through the observer service, because it is globally
available to all systems within the platform.

### API

The API being described is the information that will be transported over the
observer service.

##### Topic:

* `addon-broadcaster-get`: used by one component in a group to request
information about other components in the group (example: on setup).
* `addon-broadcaster-set`: used by one component in a group to request
information about other components in the group (example: on setup).
* `addon-broadcaster-response`: used to respond to get/set requests.
* `addon-broadcaster-notification`: used to notify observes about state changes that are
made either by the user (example: toggling checked state), or by the system (example: add-on is
unloaded and therefor the ui component group is removed/deteled)

##### Subject:

The `Addon.id` of the source UI component(s).

##### Data:

This is the interesting stuff.

* `broadcaster-id`: An `id` for the broadcaster, which will be generated by the source UI component.
* `states`: An object containing states for different scopes, where the key is the scope id.
  * scope-id: An object containing misc scope attributes.

### Examples

#### Retrieving a broadcaster's global state

```` javascript
const { get } = require('sdk/system/broadcaster');
get({
  id: broadcasterID,
  scope: 'global'
}).then(function(states) {
  let globalState = states['global'];
  // update something..
})
````

Note: the scope id for the global state is `global`

#### Retrieving a broadcaster's state for a specific window

```` javascript
const { get } = require('sdk/system/broadcaster');
get({
  id: broadcasterID,
  scope: 'window-' + window.id
}).then(function(states) {
  let windowState = states['window-' + window.id];
  // update something
})
````

#### Setting the state for a tab

```` javascript
const { set } = require('sdk/system/broadcaster');
set({
  id: broadcasterID,
  scope: 'tab-' + tab.id,
  state: {
    checked: true,
    icon: undefined,
    title: 'Thingy for Tab: ' + tab.title
  }
}).then(function(states) {
  let tabState = states['tab-' + tab.id];
  (tabState.checked === true) // is true
  (tabState.icon === undefined) // is true
  // ...
})
````

#### Listening to a broadcaster's updates

```` javascript
const { on, off } = require('sdk/system/broadcaster');
on('broadcaster-id', function broadcastListener(event) {
  if (event.type == 'delete') {
    off(broadcasterID, broadcastListener);
  }
  else if (event.type == 'update') {
    let { states } = event;
    let myNewTabState = states['tab-' + tab.id];
    // update my UI for the new state
  }
})
````

#### Getting the broadcaster for a UI element

```` javascript
const { getMostRecentBrowserWindow } = require('sdk/window/utils');

let sidebarMenuitem = getMostRecentBrowserWindow().document.getElementById(sidebarID);
let broadcasterID = sidebarMenuitem.getAttribute('data-sdk-observes');
````

#### Creating a new broadcaster

```` javascript
const { Broadcaster } = require('sdk/system/broadcaster');

let broadcaster = Broadcaster();


````

### Notes

* When there are no longer any subscribers for a broadcaster then the
broadcaster will be automatically deleted.

### Dependencies & Requirements

## Prior Art

[REST](https://en.wikipedia.org/wiki/REST)
[broadcaster XUL](https://developer.mozilla.org/en-US/docs/XUL/broadcaster)

